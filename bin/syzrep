#!/bin/bash
# SPDX-License-Identifier: GPL-2.0

help_syzrep() {
	echo "		syzrep HELP"
	echo
	echo "${0} : rc || ini || all || rep || raw || ssh COMMAND [ARGS]"
	echo
	echo "- rc :	create syzrep.rc template file."
	echo "- ini:	download needed files, prepare linux mainline sources."
	echo "- all:	download needed files, prepare linux mainline sources and"
	echo "	build kernel. try to reproduce crash and process report."
	echo "- rep:	try to reproduce crash, process report and decode."
	echo "- raw:	try to reproduce crash and leave reports alone."
	echo "	(useful for simple debugging)"
	echo "- ssh:	execute COMMAND [ARGS] in running qemu instance."
	echo "	example: ${0} ssh systemctl poweroff"
	echo
	[ "${1}" ] && echo "ERROR: ${1}"
	[ "${2}" ] && exit ${2}
	exit 1
}

rc_file() {
	echo "# Title of syzkaller bug"
	echo "# https://syzkaller.appspot.com/bug?id="
	echo "# Reported-by: syzbot+xxxxxxxxxxxxxxxxxxxx@syzkaller.appspotmail.com"
	echo 
	echo "KCONFIG_HASH="
	echo "REPRODUCER_HASH="
	echo 
	echo "HOST_PORT_SSH=10022"
	echo 
	echo "# FILTER SETTINGS"
	echo "PATTERNS_START_REPORT=(\"BUG\" \"KASAN\" \"UBSAN\" \"WARNING\" \"cut here\")"
	echo "PATTERNS_OMIT_LINE=(\"Creating new\" \"filter on device\" \"entered blocking state\" \\"
	echo "	\"entered forwarding state\" \"link becomes ready\")"
	echo "PATTERNS_OMIT_POST=(\"\${root_dir}/linux/\${KCONFIG_HASH}/\")"
}

cut_timestamps() {
	while read line; do
		if [ "${line:21:1}" == "]" ]; then
			echo "${line:23}"
		else
			echo "${line}"
		fi
	done
}

filter_out_pre() {
	while read line; do
		if [ ! "${off}" ]; then
			if [ ! "${start_report}" ]; then
				for pattern in "${PATTERNS_START_REPORT[@]}"; do
					[ "${line/${pattern}}" != "${line}" ] && start_report=1 &&\
					       echo ${line} && break
				done
			else
				[ "${line/'panic_on_warn set'}" != "${line}" ] && off=1
				found=
				for pattern in "${PATTERNS_OMIT_LINE[@]}"; do
					[ "${line/${pattern}}" != "${line}" ] && found=1 && break
				done
				[ ! "${found}" ] && echo ${line}
			fi
		fi
	done
}

remove_identical_pre() {
	all=()
	while read line; do
		linep="${line}"
		[ "${line:0:1}" == "?" ]  && linep="${line:2}"
		found=
		for eachline in "${all[@]}"; do
			if [ "${eachline}" == "${linep}" ]; then
				found=1
				break
			fi
		done
		if [ ! "${found}" ]; then
			echo "${line}"
			[ "${line}" ] && all+=("${linep}")
		fi
	done
}

remove_patterns_post() {
	while read line; do
		for pattern in "${PATTERNS_OMIT_POST[@]}"; do
			line="${line//${pattern}}"
		done
		echo "${line}"
	done
}

decode_single() {
	if [ -f "report_full${1}.txt" ] && [ "$(cat report_full${1}.txt)" ]; then
		if [ "${2}" ]; then
			cat report_full${1}.txt | filter_out_pre | remove_identical_pre > report${1}.txt
		else
			cat report_full${1}.txt | filter_out_pre > report${1}.txt
		fi
		syzrep __decode ${1}
		cat report_decoded${1}.txt | ansi2txt | remove_patterns_post > report${1}.txt
		rm report_decoded${1}.txt
		rm report_full${1}.txt
		[ ! "$(cat report${1}.txt)" ] && rm report${1}.txt
	elif [ -f "report_full${1}.txt" ]; then
		rm report_full${1}.txt
	fi
}

decode() {
	decode_single 1 remove_identical_pre
	decode_single 2
}

### https://github.com/google/syzkaller/blob/master/docs/syzbot.md ###
run() {
	qemu-system-x86_64 -smp 2 -m 4G -enable-kvm -cpu host \
		${1} -serial stdio \
		-kernel ${PWD}/linux/arch/x86/boot/bzImage \
		-device virtio-scsi-pci,id=scsi \
		-device scsi-hd,bus=scsi.0,drive=d0 \
		-device scsi-hd,bus=scsi.0,drive=d1 \
		-drive file="${root_dir}/files/debos/image.qcow2",format=qcow2,if=none,id=d0 \
		-drive file="reproducer.qcow2",format=qcow2,if=none,id=d1 \
		-snapshot -display none -no-reboot \
		-net nic -net user,hostfwd=tcp::${HOST_PORT_SSH}-:22 \
		-append "root=/dev/sda1 console=ttyS0 earlyprintk=serial \
		  oops=panic panic_on_warn=1 kvm-intel.nested=1 \
		  security=apparmor ima_policy=tcb workqueue.watchdog_thresh=140 \
		  nf-conntrack-ftp.ports=20000 nf-conntrack-tftp.ports=20000 \
		  nf-conntrack-sip.ports=20000 nf-conntrack-irc.ports=20000 \
		  nf-conntrack-sane.ports=20000 vivid.n_devs=16 \
		  vivid.multiplanar=1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2 \
		  spec_store_bypass_disable=prctl nopcid ${2}"
}

end_qemu() {
	pids="$(pidof qemu-system-x86_64)"
	for pid in ${pids}; do
		if [ -f "/proc/${pid}/cmdline" ]; then
			cmdline="$(cat /proc/${pid}/cmdline | tr "\0" " ")"
			if [ "${cmdline/-kernel ${PWD}\/linux\/arch\/x86\/boot\/bzImage}" != "${cmdline}" ]; then
				kill ${pid}
				break
			fi
		fi
	done
}

reproduce() {
	sleep 25s
	ssh -p ${HOST_PORT_SSH} -i ${root_dir}/files/debos/overlays/root/root/.ssh/id_rsa \
		root@localhost 'echo __REPORT_BEGINS_HERE > /dev/kmsg'
	ssh -p ${HOST_PORT_SSH} -i ${root_dir}/files/debos/overlays/root/root/.ssh/id_rsa \
		root@localhost /reproducer/run.sh run > report_full2.txt
	end_qemu
}
### ^^^ https://github.com/google/syzkaller/blob/master/docs/syzbot.md  ^^^ ###

__ssh() {
	[ ! "${1}" ] && help_syzrep "no command provided!" 1
	[ ! "$(pidof qemu-system-x86_64)" ] && help_syzrep "no qemu-system-x86_64 instance running!" 1
	ssh -p ${HOST_PORT_SSH} -i ${root_dir}/files/stretch.img.key root@localhost "${@}"
}

discard() {
	while read line; do
		[ "${line/__REPORT_BEGINS_HERE}" != "${line}" ] && on=1
		[ "${on}" ] && echo "${line}"
	done
}

rep() {
	[ ! -f "linux/arch/x86_64/boot/bzImage" ] && help_syzrep "bzImage not found!" 1
	count=0
	reproduce &
	run "" "panic=-1" | \
		discard | cut_timestamps | ansi2txt > report_full1.txt
}

rep_raw() {
	[ ! -f "linux/arch/x86_64/boot/bzImage" ] && help_syzrep "bzImage not found!" 1
	reproduce &
	run > report_full1.txt
}

init_syzrep() {
	if [ ! -d "${root_dir}/linux/${KCONFIG_HASH}" ]; then
		echo -n "copying linux_mainline..."
		cp -LR "${root_dir}/linux/linux" "${root_dir}/linux/${KCONFIG_HASH}"
		echo "done."
	fi
	[ ! -L "linux" ] && ln -s "${root_dir}/linux/${KCONFIG_HASH}" linux
	if [ -f "kconfig" ] && [ ! -f "linux/.config" ]; then
		cp kconfig linux/.config
	elif [ ! -f "kconfig" ]; then
		wget -O "kconfig" \
		"https://syzkaller.appspot.com/text?tag=KernelConfig&x=${KCONFIG_HASH}" || \
		help_syzrep "could not download .config!" 1
		[ ! -f "linux/.config" ] && cp kconfig linux/.config
	fi
	if [ ! -f "reproducer.syz" ]; then
		wget -O reproducer.syz \
		"https://syzkaller.appspot.com/text?tag=ReproSyz&x=${REPRODUCER_HASH}" || \
		help_syzrep "could not download syz reproducer!" 1
	fi
}

make_linux() {
	cd linux
	if [ -f ".make_linux_running" ]; then
		echo "--- WARNING! ---"
		echo "Compiling already in progress!"
		echo "If this is not the case please remove file:"
		echo "  ./linux/.make_linux_running"
		echo
		echo "Usually this happens when trying to compile the same kernel"
		echo "for a different bug from syzbot!"
		echo "exiting..."
		exit 0
	else
		touch .make_linux_running
		if ! make olddefconfig; then
			rm -f .make_linux_running
			exit 1
		fi
		if ! make -j3; then
			rm -f .make_linux_running
			exit 1
		fi
		rm -f .make_linux_running
		cd ..
	fi
}

__decode() {
	[ ! -f "report${1}.txt" ] && help_syzrep "report${1}.txt not found!" 1
	[ ! -e "linux/scripts/decode_stacktrace.sh" ] && \
		help_syzrep "linux/scripts/decode_stacktrace.sh not found!" 1
	cat report${1}.txt | linux/scripts/decode_stacktrace.sh \
		linux/vmlinux linux > report_decoded${1}.txt
}

clean_up() {
	[ -f "report_full1.txt" ] && [ ! "$(cat report_full1.txt)" ] && rm report_full1.txt
	[ -f "report_full2.txt" ] && [ ! "$(cat report_full2.txt)" ] && rm report_full2.txt
}

timestamp_rep() {
	[ -f "report1.txt" ] && mv report1.txt report-$(date +%Y-%m-%d-%H-%M-%S).txt
	[ -f "report2.txt" ] && mv report2.txt report-$(date +%Y-%m-%d-%H-%M-%S).txt
}

root_dir="${HOME}/syzrep"
conf="syzrep.rc"

if [ "${1}" == "rc" ]; then
	[ -f "${conf}" ] && help_syzrep "file ${conf} already exists!" 1
	rc_file > ${conf}
	exit 0
elif [ "${1}" == "__decode" ]; then
	__decode ${2}
	exit 0
fi

[ ! -f "${conf}" ] && help_syzrep "${conf} not found!" 1
. "${conf}"

[ ! "${HOST_PORT_SSH}" ] && help_syzrep "HOST_PORT_SSH not set!" 1

if [ "${1}" == "ssh" ]; then
	__ssh "${@:2}"
	exit 0
fi

[ ! "${REPRODUCER_HASH}" ] && help_syzrep "REPRODUCER_HASH not set!" 1
[ ! "${KCONFIG_HASH}" ] && help_syzrep "KCONFIG_HASH not set!" 1
[ ! "${PATTERNS_START_REPORT[0]}" ] && help_syzrep "PATTERNS_START_REPORT/PATTERNS_FLIP_REPORT not set!" 1

if [ "${1}" == "ini" ]; then
	init_syzrep
	exit 0
elif [ "${1}" == "all" ]; then
	init_syzrep
	make_linux
	rep
	decode
	timestamp_rep
	exit 0
elif [ "${1}" == "rep" ]; then
	rep
	decode
	timestamp_rep
	exit 0
elif [ "${1}" == "raw" ]; then
	rep_raw
	clean_up
	exit 0
fi
help_syzrep
